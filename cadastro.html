<!DOCTYPE html>
<html lang="pt-br">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6f42c1">
    <link rel="apple-touch-icon" href="icon.png">

    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
      }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novo Processo</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; padding: 20px; background-color: #f8f9fa; }
        h2 { color: #333; text-align: center; }
        label { display: block; margin-top: 10px; font-weight: bold; font-size: 0.9em; color: #555; }
        input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        
        textarea { resize: vertical; font-family: Arial, sans-serif; }

        button { width: 100%; padding: 15px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 20px; font-weight: bold; }
        button:hover { background-color: #218838; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        .back-link { display: block; margin-bottom: 20px; color: #007bff; text-decoration: none; font-weight: bold; }
        .row { display: flex; gap: 10px; }
        .col { flex: 1; }
        
        .loading { text-align: center; display: none; margin-top: 10px; color: #28a745; font-weight: bold; }

    @media (max-width: 768px) {
        body {max-width: 100% !important;margin: 10px !important;padding: 15px !important;}
        h2 {font-size: 1.5em;}
        button {padding: 18px;font-size: 18px;}
        .row {flex-direction: column;gap: 0;}
        .col {margin-bottom: 10px;}
    }
    </style>
</head>
<body style="display: none;">

    <a href="index.html" class="back-link">‚¨Ö Voltar ao Menu</a>
    <h2>Cadastrar Novo Processo</h2>
    
    <div class="row">
        <div class="col">
            <label>üìÖ Data da Venda (Relat√≥rio)</label>
            <input type="date" id="dataVenda">
        </div>
        <div class="col">
            <label>üìÇ Data de Cadastro</label>
            <input type="date" id="dataProcesso">
        </div>
    </div>

    <label>Nome do Cliente</label>
    <input type="text" id="nome" placeholder="Ex: Jo√£o da Silva">

    <div class="row">
        <div class="col">
            <label>N√∫mero da Proposta (√önico)</label>
            <input type="text" id="proposta" placeholder="Ex: 123456">
        </div>
        <div class="col">
            <label>Corretor</label>
            <select id="corretor">
                <option value="">Carregando lista...</option>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <label>Valor do Contrato (R$)</label>
            <input type="number" id="valor" step="0.01" placeholder="0,00">
        </div>
        <div class="col">
            <label>Qtd. Vidas</label>
            <input type="number" id="vidas" placeholder="1">
        </div>
    </div>

    <div class="row">
        <div class="col">
            <label>Modalidade</label>
            <select id="modalidade">
                <option value="">Selecione...</option>
                <option value="PF">Pessoa F√≠sica (PF)</option>
                <option value="PJ">Pessoa Jur√≠dica (PJ)</option>
                <option value="Ades√£o">Ades√£o</option>
            </select>
        </div>
        <div class="col">
            <label>Operadora</label>
            <select id="operadora">
                <option value="">Selecione...</option>
                <option value="Amil">Amil</option>
                <option value="Assim Sa√∫de">Assim Sa√∫de</option>
                <option value="Bradesco">Bradesco</option>
                <option value="Hapvida">Hapvida</option>
                <option value="Klini PME">Klini Sa√∫de</option>
                <option value="Leve Sa√∫de">Leve Sa√∫de</option>
                <option value="MedS√™nior">MedS√™nior</option>
                <option value="Porto Seguro">Porto Seguro</option>
                <option value="Prevent S√™nior">Prevent S√™nior</option>
                <option value="QualiCorp">QualiCorp</option>
                <option value="Solutions">Solutions</option>
                <option value="SulAm√©rica">SulAm√©rica</option>
                <option value="Supermed">Supermed</option>
                <option value="Unimed">Unimed</option>
                <option value="Outros">Outros</option>
            </select>
        </div>
    </div>

    <label>üìù Anota√ß√µes / Pend√™ncias</label>
    <textarea id="anotacoes" rows="3" placeholder="Ex: Falta comprovante..."></textarea>

    <label>Plano Contratado</label>
    <input type="text" id="plano" placeholder="Ex: Nacional Flex...">

    <label>Status Atual</label>
    <select id="status" style="background-color: #e8f0fe;">
        <option value="Enviado para aceite/DS">Enviado para aceite/DS</option>
        <option value="An√°lise">Em An√°lise</option>
        <option value="Pendente">Pendente</option>
        <option value="Pend√™ncia Resolvida">Pend√™ncia Resolvida</option>
        <option value="Proposta Liberada">Proposta Liberada</option>
        <option value="Boleto Liberado">Boleto Liberado</option>
        <option value="Implantado">Implantado (Vendido)</option>
        <option value="Cancelado">Cancelado</option>
    </select>
    
    <div id="msgCarregando" class="loading">Verificando duplicidade...</div>
    <button id="btnSalvar">Salvar Processo</button>

    <script type="module">
        import { db } from './config.js';
        import { collection, addDoc, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import './autenticacao.js';

        document.getElementById("dataProcesso").valueAsDate = new Date();

        async function carregarCorretores() {
            const selectCorretor = document.getElementById("corretor");
            
            try {
                const q = query(collection(db, "corretores"), orderBy("nome"));
                const querySnapshot = await getDocs(q);

                selectCorretor.innerHTML = '<option value="">Selecione um corretor...</option>';

                querySnapshot.forEach((doc) => {
                    const dados = doc.data();
                    const option = document.createElement("option");
                    option.value = dados.nome;
                    option.text = dados.nome;
                    selectCorretor.appendChild(option);
                });

            } catch (error) {
                console.error("Erro ao carregar corretores:", error);
                selectCorretor.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }

        carregarCorretores();

        document.getElementById("btnSalvar").addEventListener("click", async () => {
            const btn = document.getElementById("btnSalvar");
            const loading = document.getElementById("msgCarregando");

            const nome = document.getElementById("nome").value;
            const proposta = document.getElementById("proposta").value.trim();
            const dataProcesso = document.getElementById("dataProcesso").value;
            const dataVenda = document.getElementById("dataVenda").value;
            const corretor = document.getElementById("corretor").value; // Agora pega do Select
            const valor = document.getElementById("valor").value;
            const vidas = document.getElementById("vidas").value;
            const modalidade = document.getElementById("modalidade").value;
            const operadora = document.getElementById("operadora").value;
            const plano = document.getElementById("plano").value;
            const status = document.getElementById("status").value;
            const anotacoes = document.getElementById("anotacoes").value;

            if(nome === "" || proposta === "") { 
                alert("Preencha Nome e Proposta!"); 
                return; 
            }
            
            if(corretor === "") {
                alert("Selecione um Corretor!");
                return;
            }

            btn.disabled = true;
            btn.innerText = "Salvando...";
            loading.style.display = "block";

            const dataVendaFinal = dataVenda || dataProcesso;

            try {
                const qProposta = query(collection(db, "processos"), where("proposta", "==", proposta));
                const snapProposta = await getDocs(qProposta);

                if (!snapProposta.empty) {
                    alert(`‚ùå ATEN√á√ÉO: A Proposta n¬∫ ${proposta} J√Å EST√Å CADASTRADA!`);
                    resetarBotao();
                    return; 
                }

                await addDoc(collection(db, "processos"), {
                    nome: nome,
                    proposta: proposta,
                    dataProcesso: dataProcesso,
                    dataVenda: dataVendaFinal,
                    corretor: corretor, 
                    valor: valor,
                    vidas: vidas,
                    modalidade: modalidade,
                    operadora: operadora,
                    plano: plano,
                    status: status,
                    anotacoes: anotacoes,
                    criadoEm: new Date()
                });
                
                alert("‚úÖ Processo salvo com sucesso!");
                window.location.href = "lista.html"; 

            } catch (e) {
                console.error(e);
                alert("Erro ao salvar: " + e.message);
                resetarBotao();
            }

            function resetarBotao() {
                btn.disabled = false;
                btn.innerText = "Salvar Processo";
                loading.style.display = "none";
            }
        });
    </script>
</body>
</html>
