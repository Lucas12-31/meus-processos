<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meus Processos</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; padding: 20px; background-color: #f4f4f4;}
        
        .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-novo { background-color: #28a745; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; font-weight: bold; }
        .back-link { color: #555; text-decoration: none; font-weight: bold; }

        /* --- ESTILO DOS FILTROS --- */
        .filter-bar { 
            background: white; 
            padding: 15px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            margin-bottom: 20px; 
            display: flex; 
            gap: 10px; 
            flex-wrap: wrap;
        }
        .filter-group { flex: 1; min-width: 200px; }
        .filter-group label { display: block; font-size: 0.8em; font-weight: bold; color: #555; margin-bottom: 5px; }
        .filter-bar select, .filter-bar input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }

        /* Estilo do Cart√£o */
        .card { background: white; padding: 20px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 6px solid #007bff; }
        
        .card-header { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .card-title { font-size: 1.2em; font-weight: bold; color: #333; }
        .card-proposta { color: #666; font-size: 0.9em; }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .info-item { font-size: 0.9em; }
        .info-label { font-weight: bold; color: #555; display: block; }

        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; background: #e2e3e5; color: #383d41; }
        
        .actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; }
        button, .btn-link { padding: 8px 15px; cursor: pointer; border: none; border-radius: 4px; color: white; font-size: 14px; text-decoration: none; }
        .btn-del { background: #dc3545; }
        .btn-edit { background: #ffc107; color: #333; }
        
        /* Contador de resultados */
        .results-count { font-size: 0.9em; color: #666; margin-bottom: 10px; text-align: right; }
    </style>
</head>
<body>

    <div class="header-area">
        <a href="index.html" class="back-link">‚¨Ö Voltar ao Menu</a>
        <h2>Lista de Processos</h2>
        <a href="cadastro.html" class="btn-novo">+ Novo Processo</a>
    </div>

    <div class="filter-bar">
        <div class="filter-group">
            <label>üîé Buscar por Nome ou Proposta</label>
            <input type="text" id="filtroBusca" placeholder="Digite para buscar...">
        </div>
        
        <div class="filter-group">
            <label>üè¢ Filtrar por Operadora</label>
            <select id="filtroOperadora">
                <option value="">Todas as Operadoras</option>
                <option value="Amil">Amil</option>
                <option value="Assim Sa√∫de">Assim Sa√∫de</option>
                <option value="Bradesco">Bradesco</option>
                <option value="Hapvida">Hapvida</option>
                <option value="Klini PME">Klini Sa√∫de</option>
                <option value="Leve Sa√∫de">Leve Sa√∫de</option>
                <option value="MedS√™nior">MedS√™nior</option>
                <option value="Porto Seguro">Porto Seguro</option>
                <option value="Prevent S√™nior">Prevent S√™nior</option>
                <option value="QualiCorp">QualiCorp</option>
                <option value="Solutions">Solutions</option>
                <option value="SulAm√©rica">SulAm√©rica</option>
                <option value="Supermed">Supermed</option>
                <option value="Unimed">Unimed</option>
                <option value="Outros">Outros</option>
            </select>
        </div>

        <div class="filter-group">
            <label>üìå Filtrar por Status</label>
            <select id="filtroStatus">
                <option value="">Todos os Status</option>
                <option value="Enviado para aceite/DS">Enviado para aceite/DS</option>
                <option value="An√°lise">Em An√°lise</option>
                <option value="Pendente">Pendente</option>
                <option value="Pend√™ncia Resolvida">Pend√™ncia Resolvida</option>
                <option value="Proposta Liberada">Proposta Liberada</option>
                <option value="Boleto Liberado">Boleto Liberado</option>
                <option value="Implantado">Implantado (Vendido)</option>
                <option value="Cancelado">Cancelado</option>
            </select>
        </div>
    </div>

    <div class="results-count" id="contador">Carregando...</div>
    <div id="lista"></div>

    <script type="module">
        import { db } from './config.js';
        import { collection, onSnapshot, doc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const listaDiv = document.getElementById("lista");
        const contadorDiv = document.getElementById("contador");
        
        // Elementos dos filtros
        const inputBusca = document.getElementById("filtroBusca");
        const selectOperadora = document.getElementById("filtroOperadora");
        const selectStatus = document.getElementById("filtroStatus");

        // Vari√°vel global para guardar TODOS os dados originais
        let todosProcessos = [];

        // 1. BAIXAR DADOS DO FIREBASE
        const q = query(collection(db, "processos"), orderBy("criadoEm", "desc"));

        onSnapshot(q, (snapshot) => {
            todosProcessos = []; // Limpa a mem√≥ria
            
            snapshot.forEach((doc) => {
                todosProcessos.push({
                    id: doc.id,
                    ...doc.data() // Pega todos os dados (nome, operadora, etc)
                });
            });

            aplicarFiltros(); // Chama a fun√ß√£o de desenhar na tela
        });

        // 2. FUN√á√ÉO QUE FILTRA E DESENHA NA TELA
        function aplicarFiltros() {
            const termo = inputBusca.value.toLowerCase();
            const operadoraSelecionada = selectOperadora.value;
            const statusSelecionado = selectStatus.value;

            // Filtra o array global
            const filtrados = todosProcessos.filter(item => {
                // Filtro de Texto (Nome ou Proposta)
                const nomeMatch = item.nome && item.nome.toLowerCase().includes(termo);
                const propMatch = item.proposta && item.proposta.toLowerCase().includes(termo);
                const matchTexto = termo === "" || nomeMatch || propMatch;

                // Filtro de Operadora
                const matchOperadora = operadoraSelecionada === "" || item.operadora === operadoraSelecionada;

                // Filtro de Status
                const matchStatus = statusSelecionado === "" || item.status === statusSelecionado;

                return matchTexto && matchOperadora && matchStatus;
            });

            renderizarLista(filtrados);
        }

        // 3. FUN√á√ÉO QUE CRIA O HTML (MOSTRA OS CARDS)
        function renderizarLista(listaDeDados) {
            listaDiv.innerHTML = "";
            contadorDiv.innerText = `${listaDeDados.length} processos encontrados`;

            if (listaDeDados.length === 0) {
                listaDiv.innerHTML = "<p style='text-align:center; color:#888;'>Nenhum processo encontrado com esses filtros.</p>";
                return;
            }

            listaDeDados.forEach((dados) => {
                // Formata√ß√µes
                let dataFormatada = "---";
                if(dados.dataProcesso) {
                    const partes = dados.dataProcesso.split('-'); 
                    dataFormatada = `${partes[2]}/${partes[1]}/${partes[0]}`;
                }

                let valorFormatado = "R$ 0,00";
                if(dados.valor) {
                    valorFormatado = parseFloat(dados.valor).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                }

                // Cores do Status
                let borderCor = "#007bff"; // Azul padr√£o
                if(dados.status && dados.status.includes("Implantado")) borderCor = "#28a745"; // Verde
                if(dados.status && dados.status.includes("Cancelado")) borderCor = "#dc3545"; // Vermelho
                if(dados.status && dados.status.includes("Pendente")) borderCor = "#ffc107"; // Amarelo
                if(dados.status && dados.status.includes("Liberado")) borderCor = "#17a2b8"; // Ciano

                const itemDiv = document.createElement("div");
                itemDiv.className = "card";
                itemDiv.style.borderLeftColor = borderCor;

                itemDiv.innerHTML = `
                    <div class="card-header">
                        <div>
                            <span class="card-title">${dados.nome}</span>
                            <div class="card-proposta">Proposta: #${dados.proposta}</div>
                        </div>
                        <div>
                            <span class="status-badge">${dados.status || 'Sem Status'}</span>
                        </div>
                    </div>

                    <div class="info-grid">
                        <div class="info-item"><span class="info-label">üìÖ Data:</span> ${dataFormatada}</div>
                        <div class="info-item"><span class="info-label">üë§ Corretor:</span> ${dados.corretor || '--'}</div>
                        <div class="info-item"><span class="info-label">üí∞ Valor:</span> ${valorFormatado}</div>
                        <div class="info-item"><span class="info-label">üë• Vidas:</span> ${dados.vidas || '1'}</div>
                        <div class="info-item"><span class="info-label">üè¢ Operadora:</span> ${dados.operadora || '--'}</div>
                        <div class="info-item"><span class="info-label">üìã Modalidade:</span> ${dados.modalidade || '--'}</div>
                        <div class="info-item" style="grid-column: span 2;"><span class="info-label">üè• Plano:</span> ${dados.plano || '--'}</div>
                    </div>
                    
                    <div class="actions">
                        <a href="editar.html?id=${dados.id}" class="btn-link btn-edit">‚úèÔ∏è Editar</a>
                        <button class="btn-del" onclick="deletar('${dados.id}')">Excluir</button>
                    </div>
                `;
                listaDiv.appendChild(itemDiv);
            });
        }

        // EVENTOS: Sempre que mexer no filtro, roda a fun√ß√£o
        inputBusca.addEventListener("keyup", aplicarFiltros);
        selectOperadora.addEventListener("change", aplicarFiltros);
        selectStatus.addEventListener("change", aplicarFiltros);

        // FUN√á√ÉO DELETAR (Mantida igual)
        window.deletar = async (id) => {
            if(confirm("Tem certeza que deseja EXCLUIR este processo?")) {
                await deleteDoc(doc(db, "processos", id));
            }
        };
    </script>
</body>
</html>
