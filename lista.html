<!DOCTYPE html>
<html lang="pt-br">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6f42c1">
    <link rel="apple-touch-icon" href="icon.png">

    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
      }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meus Processos</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 900px; margin: 20px auto; padding: 20px; background-color: #f4f4f4;}
        
        .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-novo { background-color: #28a745; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; font-weight: bold; }
        .back-link { color: #555; text-decoration: none; font-weight: bold; }

        .filter-bar { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        .filter-group { flex: 1; min-width: 200px; }
        .filter-group label { display: block; font-size: 0.8em; font-weight: bold; color: #555; margin-bottom: 5px; }
        .filter-bar select, .filter-bar input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }

        .card { background: white; padding: 20px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 6px solid #007bff; }
        .card-header { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .card-title { font-size: 1.2em; font-weight: bold; color: #333; }
        .card-proposta { color: #666; font-size: 0.9em; }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .info-item { font-size: 0.9em; }
        .info-label { font-weight: bold; color: #555; display: block; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; background: #e2e3e5; color: #383d41; }
        
        .notes-box { background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 0.9em; }

        .actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; }
        button, .btn-link { padding: 8px 15px; cursor: pointer; border: none; border-radius: 4px; color: white; font-size: 14px; text-decoration: none; }
        .btn-del { background: #dc3545; }
        .btn-edit { background: #ffc107; color: #333; }
        .results-count { font-size: 0.9em; color: #666; margin-bottom: 10px; text-align: right; }

        .pagination-area { display: flex; justify-content: center; gap: 5px; margin-top: 20px; }
        .page-btn { background: white; border: 1px solid #ddd; color: #333; padding: 8px 12px; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .page-btn:hover { background-color: #eee; }
        .page-btn.active { background-color: #007bff; color: white; border-color: #007bff; }


        @media (max-width: 768px) {
        body {
            margin: 10px auto !important;
            padding: 10px !important;
        }
        .filter-bar {
            flex-direction: column; 
            gap: 15px; 
        }
        .filter-group {min-width: 100%;}
        .card-header {
            flex-direction: column; 
            align-items: flex-start; 
            gap: 10px; 
        }
        .card-title, .card-name {
            font-size: 1.1em;
            word-break: break-word; 
        }
        .status-badge, .grade-badge {
            align-self: flex-start; 
            font-size: 0.75em;
        }
        .info-grid {grid-template-columns: 1fr;}
        .info-item[style*="grid-column: span 2"] {grid-column: span 1 !important;}
    }
    </style>
</head>
<body style="display: none;">

    <div class="header-area">
        <a href="index.html" class="back-link">‚¨Ö Voltar ao Menu</a>
        <h2>Lista de Processos</h2>
        <a href="cadastro.html" class="btn-novo">+ Novo Processo</a>
    </div>

    <div class="filter-bar">
        <div class="filter-group">
            <label>üîé Buscar por Nome ou Proposta</label>
            <input type="text" id="filtroBusca" placeholder="Digite para buscar...">
        </div>
        <div class="filter-group">
            <label>üè¢ Filtrar por Operadora</label>
            <select id="filtroOperadora">
                <option value="">Todas as Operadoras</option>
                <option value="Amil">Amil</option>
                <option value="Assim Sa√∫de">Assim Sa√∫de</option>
                <option value="Bradesco">Bradesco</option>
                <option value="Hapvida">Hapvida</option>
                <option value="Klini PME">Klini Sa√∫de</option>
                <option value="Leve Sa√∫de">Leve Sa√∫de</option>
                <option value="MedS√™nior">MedS√™nior</option>
                <option value="Porto Seguro">Porto Seguro</option>
                <option value="Prevent S√™nior">Prevent S√™nior</option>
                <option value="QualiCorp">QualiCorp</option>
                <option value="Solutions">Solutions</option>
                <option value="SulAm√©rica">SulAm√©rica</option>
                <option value="Supermed">Supermed</option>
                <option value="Unimed">Unimed</option>
                <option value="Outros">Outros</option>
            </select>
        </div>
        <div class="filter-group">
            <label>üìå Filtrar por Status</label>
            <select id="filtroStatus">
                <option value="">Todos os Status</option>
                <option value="Enviado para aceite/DS">Enviado para aceite/DS</option>
                <option value="An√°lise">Em An√°lise</option>
                <option value="Pendente">Pendente</option>
                <option value="Pend√™ncia Resolvida">Pend√™ncia Resolvida</option>
                <option value="Proposta Liberada">Proposta Liberada</option>
                <option value="Boleto Liberado">Boleto Liberado</option>
                <option value="Implantado">Implantado (Vendido)</option>
                <option value="Cancelado">Cancelado</option>
            </select>
        </div>
    </div>

    <div class="results-count" id="contador">Carregando...</div>
    <div id="lista"></div>
    <div id="pagination" class="pagination-area"></div>

    <script type="module">
        import { db } from './config.js';
        import { collection, onSnapshot, doc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import './autenticacao.js';

        const listaDiv = document.getElementById("lista");
        const contadorDiv = document.getElementById("contador");
        const paginacaoDiv = document.getElementById("pagination");
        const inputBusca = document.getElementById("filtroBusca");
        const selectOperadora = document.getElementById("filtroOperadora");
        const selectStatus = document.getElementById("filtroStatus");

        let todosProcessos = []; 
        let paginaAtual = 1;
        const itensPorPagina = 5; 

        const q = query(collection(db, "processos"), orderBy("criadoEm", "desc"));

        onSnapshot(q, (snapshot) => {
            todosProcessos = [];
            snapshot.forEach((doc) => {
                todosProcessos.push({ id: doc.id, ...doc.data() });
            });
            aplicarFiltros();
        });

        function aplicarFiltros() {
            const termo = inputBusca.value.toLowerCase();
            const operadoraSelecionada = selectOperadora.value;
            const statusSelecionado = selectStatus.value;

            const filtrados = todosProcessos.filter(item => {
                const nomeMatch = item.nome && item.nome.toLowerCase().includes(termo);
                const propMatch = item.proposta && item.proposta.toLowerCase().includes(termo);
                const matchTexto = termo === "" || nomeMatch || propMatch;
                const matchOperadora = operadoraSelecionada === "" || item.operadora === operadoraSelecionada;
                const matchStatus = statusSelecionado === "" || item.status === statusSelecionado;
                return matchTexto && matchOperadora && matchStatus;
            });

            renderizarLista(filtrados);
        }

        function renderizarLista(listaDeDados) {
            listaDiv.innerHTML = "";
            paginacaoDiv.innerHTML = ""; 
            contadorDiv.innerText = `${listaDeDados.length} processos encontrados`;

            if (listaDeDados.length === 0) {
                listaDiv.innerHTML = "<p style='text-align:center; color:#888;'>Nenhum processo encontrado.</p>";
                return;
            }

            const inicio = (paginaAtual - 1) * itensPorPagina;
            const fim = inicio + itensPorPagina;
            const processosDaPagina = listaDeDados.slice(inicio, fim);

            processosDaPagina.forEach((dados) => {
                let dataParaMostrar = dados.dataVenda || dados.dataProcesso;
                let dataFormatada = "---";
                if(dataParaMostrar) {
                    const partes = dataParaMostrar.split('-'); 
                    dataFormatada = `${partes[2]}/${partes[1]}/${partes[0]}`;
                }

                let valorFormatado = "R$ 0,00";
                if(dados.valor) {
                    valorFormatado = parseFloat(dados.valor).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                }

                let borderCor = "#007bff";
                if(dados.status && dados.status.includes("Implantado")) borderCor = "#28a745";
                if(dados.status && dados.status.includes("Cancelado")) borderCor = "#dc3545";
                if(dados.status && dados.status.includes("Pendente")) borderCor = "#ffc107";
                if(dados.status && dados.status.includes("Liberado")) borderCor = "#17a2b8";

                let htmlAnotacoes = "";
                if (dados.anotacoes && dados.anotacoes.trim() !== "") {
                    htmlAnotacoes = `<div class="notes-box"><strong>üìù Anota√ß√µes:</strong> ${dados.anotacoes}</div>`;
                }

                const itemDiv = document.createElement("div");
                itemDiv.className = "card";
                itemDiv.style.borderLeftColor = borderCor;

                itemDiv.innerHTML = `
                    <div class="card-header">
                        <div>
                            <span class="card-title">${dados.nome}</span>
                            <div class="card-proposta">Proposta: #${dados.proposta}</div>
                        </div>
                        <div>
                            <span class="status-badge">${dados.status || 'Sem Status'}</span>
                        </div>
                    </div>

                    <div class="info-grid">
                        <div class="info-item"><span class="info-label">üìÖ Venda:</span> ${dataFormatada}</div>
                        <div class="info-item"><span class="info-label">üë§ Corretor:</span> ${dados.corretor || '--'}</div>
                        <div class="info-item"><span class="info-label">üí∞ Valor:</span> ${valorFormatado}</div>
                        <div class="info-item"><span class="info-label">üë• Vidas:</span> ${dados.vidas || '1'}</div>
                        <div class="info-item"><span class="info-label">üè¢ Operadora:</span> ${dados.operadora || '--'}</div>
                        <div class="info-item"><span class="info-label">üìã Modalidade:</span> ${dados.modalidade || '--'}</div>
                        <div class="info-item" style="grid-column: span 2;"><span class="info-label">üè• Plano:</span> ${dados.plano || '--'}</div>
                    </div>
                    
                    ${htmlAnotacoes} <div class="actions">
                        <a href="editar.html?id=${dados.id}" class="btn-link btn-edit">‚úèÔ∏è Editar</a>
                        <button class="btn-del" onclick="deletar('${dados.id}')">Excluir</button>
                    </div>
                `;
                listaDiv.appendChild(itemDiv);
            });

            const totalPaginas = Math.ceil(listaDeDados.length / itensPorPagina);

            if (totalPaginas > 1) {
                for (let i = 1; i <= totalPaginas; i++) {
                    const btn = document.createElement("button");
                    btn.innerText = i;
                    btn.className = "page-btn";
                    if (i === paginaAtual) btn.classList.add("active");
                    
                    btn.addEventListener("click", () => {
                        paginaAtual = i;
                        renderizarLista(listaDeDados); 
                        window.scrollTo(0, 0); 
                    });
                    paginacaoDiv.appendChild(btn);
                }
            }
        }

        function resetarEFiltrar() {
            paginaAtual = 1;
            aplicarFiltros();
        }

        inputBusca.addEventListener("keyup", resetarEFiltrar);
        selectOperadora.addEventListener("change", resetarEFiltrar);
        selectStatus.addEventListener("change", resetarEFiltrar);

        window.deletar = async (id) => {
            if(confirm("Tem certeza que deseja EXCLUIR este processo?")) {
                await deleteDoc(doc(db, "processos", id));
            }
        };
    </script>
</body>
</html>
