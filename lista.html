<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meus Processos</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; padding: 20px; background-color: #f4f4f4;}
        
        .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-novo { background-color: #28a745; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; font-weight: bold; }
        .back-link { color: #555; text-decoration: none; font-weight: bold; }

        .card { background: white; padding: 20px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 6px solid #007bff; }
        
        .card-header { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .card-title { font-size: 1.2em; font-weight: bold; color: #333; }
        .card-proposta { color: #666; font-size: 0.9em; }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .info-item { font-size: 0.9em; }
        .info-label { font-weight: bold; color: #555; display: block; }

        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; background: #e2e3e5; color: #383d41; }
        
        .actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; }
        button, .btn-link { padding: 8px 15px; cursor: pointer; border: none; border-radius: 4px; color: white; font-size: 14px; text-decoration: none; }
        .btn-del { background: #dc3545; }
        .btn-edit { background: #ffc107; color: #333; }
    </style>
</head>
<body>

    <div class="header-area">
        <a href="index.html" class="back-link">‚¨Ö Voltar ao Menu</a>
        <h2>Lista de Processos</h2>
        <a href="cadastro.html" class="btn-novo">+ Novo Processo</a>
    </div>

    <div id="lista">Carregando processos...</div>

    <script type="module">
        import { db } from './config.js';
        import { collection, onSnapshot, doc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const listaDiv = document.getElementById("lista");
        const q = query(collection(db, "processos"), orderBy("criadoEm", "desc"));

        onSnapshot(q, (snapshot) => {
            listaDiv.innerHTML = "";
            
            if (snapshot.empty) {
                listaDiv.innerHTML = "<p style='text-align:center'>Nenhum processo encontrado.</p>";
                return;
            }

            snapshot.forEach((item) => {
                const dados = item.data();
                const id = item.id;

                let dataFormatada = "---";
                if(dados.dataProcesso) {
                    const partes = dados.dataProcesso.split('-'); 
                    dataFormatada = `${partes[2]}/${partes[1]}/${partes[0]}`;
                }

                let valorFormatado = "R$ 0,00";
                if(dados.valor) {
                    valorFormatado = parseFloat(dados.valor).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                }

                const itemDiv = document.createElement("div");
                itemDiv.className = "card";
                
                let borderCor = "#007bff";
                if(dados.status === "Implantado") borderCor = "#28a745";
                if(dados.status === "Cancelado") borderCor = "#dc3545";
                itemDiv.style.borderLeftColor = borderCor;

                itemDiv.innerHTML = `
                    <div class="card-header">
                        <div>
                            <span class="card-title">${dados.nome}</span>
                            <div class="card-proposta">Proposta: #${dados.proposta}</div>
                        </div>
                        <div>
                            <span class="status-badge">${dados.status || 'Sem Status'}</span>
                        </div>
                    </div>

                    <div class="info-grid">
                        <div class="info-item"><span class="info-label">üìÖ Data:</span> ${dataFormatada}</div>
                        <div class="info-item"><span class="info-label">üë§ Corretor:</span> ${dados.corretor || '--'}</div>
                        <div class="info-item"><span class="info-label">üí∞ Valor:</span> ${valorFormatado}</div>
                        <div class="info-item"><span class="info-label">üë• Vidas:</span> ${dados.vidas || '1'}</div>
                        <div class="info-item"><span class="info-label">üè¢ Operadora:</span> ${dados.operadora || '--'}</div>
                        <div class="info-item"><span class="info-label">üìã Modalidade:</span> ${dados.modalidade || '--'}</div>
                        <div class="info-item" style="grid-column: span 2;"><span class="info-label">üè• Plano:</span> ${dados.plano || '--'}</div>
                    </div>
                    
                    <div class="actions">
                        <a href="editar.html?id=${id}" class="btn-link btn-edit">‚úèÔ∏è Editar</a>
                        <button class="btn-del" onclick="deletar('${id}')">Excluir</button>
                    </div>
                `;
                listaDiv.appendChild(itemDiv);
            });
        });

        window.deletar = async (id) => {
            if(confirm("Tem certeza que deseja EXCLUIR este processo?")) {
                await deleteDoc(doc(db, "processos", id));
            }
        };
    </script>
</body>
</html>
